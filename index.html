<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>旅遊收支記帳管家 - GitHub Gist 雲端版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .receipt-preview { max-width: 100px; max-height: 100px; cursor: pointer; border-radius: 8px; transition: transform 0.2s; }
        .receipt-preview:hover { transform: scale(1.05); }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .tab-active { background-color: #3b82f6; color: white; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 5% auto; padding: 20px; border-radius: 12px; width: 90%; max-width: 600px; max-height: 85vh; overflow-y: auto; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .chart-container { position: relative; height: 300px; width: 100%; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .cloud-status-bar { transition: all 0.3s ease; cursor: pointer; }
        .sync-badge { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .disabled { opacity: 0.5; cursor: not-allowed; }
        .success-box { background: #dcfce7; border-left: 4px solid #22c55e; }
        .warning-box { background: #fef3c7; border-left: 4px solid #f59e0b; }
        .loading-spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
		
		.tag-item {
			background-color: #ebf5ff;
			color: #2563eb;
			padding: 2px 8px;
			border-radius: 4px;
			display: flex;
			align-items: center;
			font-size: 0.875rem;
		}
		.tag-close {
			margin-left: 6px;
			cursor: pointer;
			color: #93c5fd;
		}
		.tag-close:hover {
			color: #1d4ed8;
		}
		
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <!-- 頂部導航 -->
    <nav class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fas fa-wallet text-2xl"></i>
                <h1 class="text-xl font-bold">旅遊記帳管家</h1>
            </div>
            <div class="flex items-center space-x-2 relative">
                <div id="cloudStatus" class="text-sm bg-blue-700 px-3 py-1 rounded-full cloud-status-bar" title="點擊查看同步狀態">
                    <i class="fas fa-cloud"></i> 雲端未設定
                </div>
                <div id="syncStatus" class="hidden text-xs bg-white text-blue-600 px-2 py-1 rounded-full"></div>
                <button id="cloudConfigBtn" class="bg-purple-600 text-white px-3 py-1 rounded-md text-sm font-medium">
                    <i class="fas fa-cog"></i> 雲端設定
                </button>
            </div>
        </div>
    </nav>

    <!-- 主內容區 -->
    <main class="container mx-auto px-4 py-6">
        <!-- 雲端設定提示 -->
        <div id="cloudSetupInfo" class="warning-box p-4 rounded-lg mb-4 hidden animate-fade-in">
            <h3 class="font-bold text-yellow-800 mb-2">
                <i class="fas fa-exclamation-triangle"></i> 雲端備份未設定
            </h3>
            <p class="text-sm text-gray-700 mb-2">
                點擊右上角「雲端設定」按鈕，輸入 GitHub Token 和 Gist ID 即可啟用自動備份功能。
            </p>
            <p class="text-sm text-gray-700">
                提示：您也可以使用下方的「匯出/匯入」功能手動備份。
            </p>
        </div>

        <!-- 快速操作區 -->
        <div class="bg-white rounded-xl shadow-md p-3 mb-4 animate-fade-in">
            <div class="flex flex-wrap gap-2 justify-between items-center">
                <div class="text-sm text-gray-600">
                    <i class="fas fa-info-circle text-blue-600"></i> 
                    <span id="syncStatusText">資料儲存在瀏覽器中</span>
                </div>
                <div class="flex gap-2">
                    <button id="cloudSyncBtn" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 transition hidden">
                        <i class="fas fa-cloud-upload-alt"></i> 雲端備份
                    </button>
                    <button id="cloudDownloadBtn" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 transition hidden">
                        <i class="fas fa-cloud-download-alt"></i> 雲端還原
                    </button>
                    <button id="exportBtn" class="bg-gray-600 text-white px-3 py-1 rounded text-sm hover:bg-gray-700 transition">
                        <i class="fas fa-file-export"></i> 匯出
                    </button>
                    <label for="importFile" class="bg-gray-600 text-white px-3 py-1 rounded text-sm hover:bg-gray-700 transition cursor-pointer">
                        <i class="fas fa-file-import"></i> 匯入
                    </label>
                    <input type="file" id="importFile" accept=".json" class="hidden">
                </div>
            </div>
        </div>

        <!-- 帳冊選擇區 -->
        <div class="bg-white rounded-xl shadow-md p-4 mb-6 animate-fade-in">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                <h2 class="text-lg font-bold text-gray-700 mb-2 md:mb-0">
                    <i class="fas fa-book"></i> 帳冊管理
                </h2>
                <div class="flex space-x-2 w-full md:w-auto">
                    <select id="ledgerSelect" class="flex-1 md:flex-none bg-gray-100 border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">請選擇帳冊</option>
                    </select>
                    <button id="addLedgerBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
                        <i class="fas fa-plus"></i> 新增
                    </button>
                    <button id="editLedgerBtn" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 transition">
                        <i class="fas fa-edit"></i> 設定
                    </button>
                </div>
            </div>
            <!-- 帳冊設定預覽 -->
            <div id="ledgerInfo" class="hidden bg-blue-50 p-3 rounded-lg text-sm">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div><strong>科目：</strong><span id="ledgerCategories"></span></div>
                    <div><strong>地點：</strong><span id="ledgerLocations"></span></div>
                    <div><strong>成員：</strong><span id="ledgerMembers"></span></div>
                </div>
            </div>
        </div>

        <!-- 功能標籤頁 -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden animate-fade-in">
            <div class="flex border-b">
                <button class="tab-btn tab-active flex-1 py-3 px-4 text-center font-medium hover:bg-gray-50" data-tab="expenses">
                    <i class="fas fa-receipt"></i> 支出記錄
                </button>
                <button class="tab-btn flex-1 py-3 px-4 text-center font-medium hover:bg-gray-50" data-tab="query">
                    <i class="fas fa-search"></i> 查詢統計
                </button>
                <button class="tab-btn flex-1 py-3 px-4 text-center font-medium hover:bg-gray-50" data-tab="charts">
                    <i class="fas fa-chart-bar"></i> 分析圖表
                </button>
            </div>

            <!-- 支出記錄標籤頁 -->
            <div id="expensesTab" class="p-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg">支出明細</h3>
                    <button id="addExpenseBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">
                        <i class="fas fa-plus"></i> 新增支出
                    </button>
                </div>
                
                <!-- 支出列表 -->
                <div id="expenseList" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                    <!-- 支出項目將在這裡動態生成 -->
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-info-circle text-2xl mb-2"></i>
                        <p>請先選擇或建立帳冊，然後新增支出</p>
                    </div>
                </div>
            </div>

            <!-- 查詢統計標籤頁 -->
            <div id="queryTab" class="p-4 hidden">
                <div class="bg-gray-50 p-4 rounded-lg mb-4">
                    <h3 class="font-bold mb-3">查詢條件</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div>
                            <label class="block text-sm font-medium mb-1">支付者</label>
                            <select id="queryPayer" class="w-full bg-white border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">全部</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">分攤人員</label>
                            <select id="querySplitter" class="w-full bg-white border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">全部</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">結帳狀態</label>
                            <select id="querySettled" class="w-full bg-white border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">全部</option>
                                <option value="true">已結帳</option>
                                <option value="false">未結帳</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-3 flex justify-end">
                        <button id="queryBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
                            <i class="fas fa-search"></i> 查詢
                        </button>
                    </div>
                </div>

                <!-- 查詢結果 -->
                <div id="queryResults" class="hidden">
                    <div class="bg-green-50 p-4 rounded-lg mb-4">
                        <h4 class="font-bold mb-2">統計結果</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
                            <div class="bg-white p-3 rounded shadow">
                                <div class="text-gray-500">總支出金額</div>
                                <div id="totalAmount" class="text-xl font-bold text-green-600">0</div>
                            </div>
                            <div class="bg-white p-3 rounded shadow">
                                <div class="text-gray-500">符合條件的支出筆數</div>
                                <div id="totalCount" class="text-xl font-bold text-blue-600">0</div>
                            </div>
                            <div class="bg-white p-3 rounded shadow">
                                <div class="text-gray-500">分攤人員應付金額</div>
                                <div id="splitterAmount" class="text-xl font-bold text-purple-600">0</div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-lg shadow">
                        <h4 class="font-bold mb-3">分攤明細</h4>
                        <div id="splitterDetails" class="space-y-2 max-h-64 overflow-y-auto">
                            <!-- 分攤明細將在這裡生成 -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- 分析圖表標籤頁 -->
            <div id="chartsTab" class="p-4 hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- 支付者支出統計圖 -->
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h3 class="font-bold mb-3">支付者支出統計</h3>
                        <div class="chart-container">
                            <canvas id="payerChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- 分攤人員統計圖 -->
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h3 class="font-bold mb-3">分攤人員收支統計</h3>
                        <div class="chart-container">
                            <canvas id="splitterChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 雲端設定模態框 -->
    <div id="cloudConfigModal" class="modal">
        <div class="modal-content animate-fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">雲端備份設定</h3>
                <button class="closeModal text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="bg-blue-50 p-3 rounded-lg mb-4 text-sm">
                <p class="mb-2"><strong>如何取得設定資訊：</strong></p>
                <ol class="list-decimal list-inside space-y-1 text-gray-700">
                    <li>建立 Personal Access Token：<a href="https://github.com/settings/tokens" target="_blank" class="text-blue-600 underline">點此前往</a>（權限只勾選 gist）</li>
                    <li>建立 Gist：<a href="https://gist.github.com/" target="_blank" class="text-blue-600 underline">點此前往</a>（設為 Private）</li>
                    <li>複製 Gist ID（網址最後的字串）</li>
                </ol>
            </div>

            <form id="cloudConfigForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-1">GitHub Personal Access Token</label>
                    <input type="password" id="githubToken" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ghp_...">
                    <div class="mt-1 flex items-center">
                        <input type="checkbox" id="showToken" class="mr-2">
                        <label for="showToken" class="text-sm text-gray-600">顯示 token</label>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-1">Gist ID</label>
                    <input type="text" id="gistId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="例如：a1b2c3d4e5f6g7h8i9j0">
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" class="closeModal bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400 transition">取消</button>
                    <button type="submit" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 transition">儲存設定</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 新增/編輯帳冊模態框 -->
    <div id="ledgerModal" class="modal">
        <div class="modal-content animate-fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 id="ledgerModalTitle" class="text-xl font-bold">新增帳冊</h3>
                <button class="closeModal text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="ledgerForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-1">帳冊名稱</label>
                    <input type="text" id="ledgerName" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="例如：日本東京七日遊">
                </div>
				
				<div class="mb-4">
					<label class="block text-sm font-medium mb-1">科目 (輸入後按 Enter 新增)</label>
					<div class="flex flex-wrap gap-2 p-2 border border-gray-300 rounded focus-within:ring-2 focus-within:ring-blue-500" id="categoryTagsContainer">
						<input type="text" id="categoryInput" class="flex-1 outline-none text-sm min-w-[100px]" placeholder="例如：餐飲">
					</div>
				</div>
				<div class="mb-4">
					<label class="block text-sm font-medium mb-1">地點 (輸入後按 Enter 新增)</label>
					<div class="flex flex-wrap gap-2 p-2 border border-gray-300 rounded focus-within:ring-2 focus-within:ring-blue-500" id="locationTagsContainer">
						<input type="text" id="locationInput" class="flex-1 outline-none text-sm min-w-[100px]" placeholder="例如：東京">
					</div>
				</div>
				<div class="mb-4">
					<label class="block text-sm font-medium mb-1">分攤人員 (輸入後按 Enter 新增)</label>
					<div class="flex flex-wrap gap-2 p-2 border border-gray-300 rounded focus-within:ring-2 focus-within:ring-blue-500" id="memberTagsContainer">
						<input type="text" id="memberInput" class="flex-1 outline-none text-sm min-w-[100px]" placeholder="例如：小明">
					</div>
				</div>
				
                <div class="flex justify-end space-x-2">
                    <button type="button" class="closeModal bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400 transition">取消</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">儲存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 新增/編輯支出模態框 -->
    <div id="expenseModal" class="modal">
        <div class="modal-content animate-fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 id="expenseModalTitle" class="text-xl font-bold">新增支出</h3>
                <button class="closeModal text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="expenseForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">日期</label>
                        <input type="date" id="expenseDate" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">時間</label>
                        <input type="time" id="expenseTime" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">科目</label>
                        <select id="expenseCategory" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">請選擇</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">地點</label>
                        <select id="expenseLocation" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">請選擇</option>
                        </select>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium mb-1">摘要</label>
                    <input type="text" id="expenseDescription" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="例如：午餐、門票、車資">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">支出金額</label>
                        <input type="number" id="expenseAmount" required min="0" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="0.00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">支付者</label>
                        <select id="expensePayer" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">請選擇</option>
                        </select>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium mb-1">分攤人員 (可多選)</label>
                    <div id="expenseSplitters" class="border border-gray-300 rounded p-2 max-h-32 overflow-y-auto">
                        <!-- 動態生成複選框 -->
                    </div>
                    <div class="mt-1 text-sm text-gray-500">
                        平均分攤金額：<span id="averageAmount" class="font-bold text-blue-600">0</span>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">是否結帳</label>
                        <div class="flex items-center mt-2">
                            <input type="checkbox" id="expenseSettled" class="mr-2 w-4 h-4">
                            <span>已結帳</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">收據</label>
                        <input type="file" id="expenseReceipt" accept="image/*" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                        <div id="receiptPreview" class="mt-2 hidden">
                            <img id="receiptImagePreview" class="receipt-preview" alt="收據預覽">
                        </div>
                    </div>
                </div>

                <div class="flex justify-end space-x-2">
                    <button type="button" class="closeModal bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400 transition">取消</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">儲存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 收據預覽模態框 -->
    <div id="receiptViewModal" class="modal">
        <div class="modal-content animate-fade-in" style="max-width: 800px;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">收據圖片</h3>
                <button class="closeModal text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="flex justify-center">
                <img id="receiptViewImage" class="max-w-full max-h-80 rounded shadow" alt="收據大圖">
            </div>
        </div>
    </div>

    <!-- 提示訊息 -->
    <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-4 py-2 rounded shadow-lg hidden z-50">
        <span id="toastMessage"></span>
    </div>

    <!-- 同步中遮罩 -->
    <div id="syncOverlay" class="fixed inset-0 bg-black bg-opacity-30 hidden z-40 flex items-center justify-center">
        <div class="bg-white px-6 py-4 rounded-lg shadow-lg text-center">
            <i class="fas fa-sync-alt fa-spin text-2xl text-blue-600 mb-2"></i>
            <div class="font-bold">處理中...</div>
            <div class="text-sm text-gray-500 mt-1">請稍候</div>
        </div>
    </div>

    <script>
        // ==================== GitHub Gist 雲端系統 ====================
        
        class GitHubGistCloudSystem {
            constructor() {
                this.token = null;
                this.gistId = null;
                this.fileName = 'travel-accounting-data.json';
            }

            // 檢查是否已設定
            isConfigured() {
                return this.token && this.gistId;
            }

            // 設定
            configure(token, gistId) {
                this.token = token;
                this.gistId = gistId;
                localStorage.setItem('githubToken', token);
                localStorage.setItem('gistId', gistId);
            }

            // 從 LocalStorage 讀取設定
            loadConfig() {
                this.token = localStorage.getItem('githubToken');
                this.gistId = localStorage.getItem('gistId');
                return this.isConfigured();
            }

            // 清除設定
            clearConfig() {
                this.token = null;
                this.gistId = null;
                localStorage.removeItem('githubToken');
                localStorage.removeItem('gistId');
            }

            // 備份到 Gist
            async backup(data) {
                try {
                    if (!this.isConfigured()) {
                        throw new Error('未設定 GitHub 憑證');
                    }

                    showSyncOverlay(true, '正在上傳到 GitHub Gist...');

                    // 檢查 Gist 是否存在
                    const gistResponse = await fetch(`https://api.github.com/gists/${this.gistId}`, {
                        headers: {
                            'Authorization': `token ${this.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    if (!gistResponse.ok) {
                        throw new Error('無法存取 Gist，請檢查 Gist ID 和 Token');
                    }

                    const gistData = await gistResponse.json();

                    // 準備要上傳的內容
                    const fileContent = JSON.stringify(data, null, 2);
                    
                    // 檢查 Gist 中是否已有此檔案
                    const existingFile = gistData.files[this.fileName];
                    
                    if (existingFile) {
                        // 比較內容，如果相同則不更新
                        const existingContent = existingFile.content;
                        if (existingContent === fileContent) {
                            return { success: true, message: '內容相同，無需更新' };
                        }
                    }

                    // 更新 Gist
                    const updateResponse = await fetch(`https://api.github.com/gists/${this.gistId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `token ${this.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            files: {
                                [this.fileName]: {
                                    content: fileContent
                                }
                            }
                        })
                    });

                    if (!updateResponse.ok) {
                        const error = await updateResponse.json();
                        throw new Error(`上傳失敗: ${error.message}`);
                    }

                    return { success: true, message: '備份成功' };

                } catch (error) {
                    console.error('備份失敗:', error);
                    return { success: false, error: error.message };
                } finally {
                    showSyncOverlay(false);
                }
            }

            // 從 Gist 還原
            async restore() {
                try {
                    if (!this.isConfigured()) {
                        throw new Error('未設定 GitHub 憑證');
                    }

                    showSyncOverlay(true, '正在從 GitHub Gist 下載...');

                    const response = await fetch(`https://api.github.com/gists/${this.gistId}`, {
                        headers: {
                            'Authorization': `token ${this.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error('無法存取 Gist，請檢查 Gist ID 和 Token');
                    }

                    const gistData = await response.json();
                    const file = gistData.files[this.fileName];

                    if (!file) {
                        return { success: false, error: 'Gist 中找不到資料檔案' };
                    }

                    const data = JSON.parse(file.content);
                    return { success: true, data: data };

                } catch (error) {
                    console.error('還原失敗:', error);
                    return { success: false, error: error.message };
                } finally {
                    showSyncOverlay(false);
                }
            }
        }

        // ==================== 主應用程式 ====================
        
        // 資料存儲結構
        let appData = {
            ledgers: [],
            currentLedgerId: null,
            expenses: []
        };

        // 雲端系統實例
        const cloudSystem = new GitHubGistCloudSystem();
        
        // 同步狀態
        let syncState = {
            lastSyncTime: null,
            isSyncing: false
        };

        // 當前正在編輯的支出ID
        let currentEditingExpenseId = null;

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadFromLocalStorage();
            setupEventListeners();
            updateUI();
            
            // 檢查雲端設定
            if (cloudSystem.loadConfig()) {
                updateCloudStatus();
            } else {
                document.getElementById('cloudSetupInfo').classList.remove('hidden');
            }
        });


		// 標籤管理器資料
		let tempTags = { categories: [], locations: [], members: [] };

		function renderTags(type, containerId) {
			const container = document.getElementById(containerId);
			const input = container.querySelector('input');
			// 清除舊標籤
			container.querySelectorAll('.tag-item').forEach(el => el.remove());
			
			// 渲染新標籤
			tempTags[type].forEach((tag, index) => {
				const span = document.createElement('span');
				span.className = 'tag-item';
				span.innerHTML = `${tag}<i class="fas fa-times tag-close" onclick="removeTag('${type}', ${index}, '${containerId}')"></i>`;
				container.insertBefore(span, input);
			});
		}

		function removeTag(type, index, containerId) {
			tempTags[type].splice(index, 1);
			renderTags(type, containerId);
		}

		function setupTagInput(inputId, containerId, type) {
			const input = document.getElementById(inputId);
			input.addEventListener('keydown', function(e) {
				if (e.key === 'Enter') {
					e.preventDefault();
					const val = this.value.trim();
					if (val && !tempTags[type].includes(val)) {
						tempTags[type].push(val);
						renderTags(type, containerId);
						this.value = '';
					}
				}
			});
		}


        // 設置事件監聽器
        function setupEventListeners() {
		
			// 在 setupEventListeners 函數內加入
			setupTagInput('categoryInput', 'categoryTagsContainer', 'categories');
			setupTagInput('locationInput', 'locationTagsContainer', 'locations');
			setupTagInput('memberInput', 'memberTagsContainer', 'members');

            // 標籤頁切換
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tab = this.getAttribute('data-tab');
                    switchTab(tab);
                });
            });

            // 帳冊操作
            document.getElementById('addLedgerBtn').addEventListener('click', () => openLedgerModal());
            document.getElementById('editLedgerBtn').addEventListener('click', () => editCurrentLedger());
            document.getElementById('ledgerSelect').addEventListener('change', function() {
                appData.currentLedgerId = this.value;
                updateLedgerInfo();
                updateExpenseList();
                updateQueryOptions();
            });

            // 支出操作
            document.getElementById('addExpenseBtn').addEventListener('click', () => openExpenseModal());

            // 表單提交
            document.getElementById('ledgerForm').addEventListener('submit', handleLedgerSubmit);
            document.getElementById('expenseForm').addEventListener('submit', handleExpenseSubmit);
            document.getElementById('queryBtn').addEventListener('click', handleQuery);
            document.getElementById('cloudConfigForm').addEventListener('submit', handleCloudConfig);

            // 雲端操作
            document.getElementById('cloudConfigBtn').addEventListener('click', openCloudConfigModal);
            document.getElementById('cloudSyncBtn').addEventListener('click', manualBackup);
            document.getElementById('cloudDownloadBtn').addEventListener('click', manualRestore);

            // 匯出/匯入
            document.getElementById('exportBtn').addEventListener('click', exportData);
            document.getElementById('importFile').addEventListener('change', importData);

            // 收據上傳預覽
            document.getElementById('expenseReceipt').addEventListener('change', previewReceipt);

            // Token 顯示切換
            document.getElementById('showToken').addEventListener('change', function() {
                const tokenInput = document.getElementById('githubToken');
                tokenInput.type = this.checked ? 'text' : 'password';
            });

            // 模態框關閉
            document.querySelectorAll('.closeModal').forEach(btn => {
                btn.addEventListener('click', function() {
                    this.closest('.modal').style.display = 'none';
                });
            });

            // 點擊模態框外部關閉
            window.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });

            // 雲端狀態點擊事件
            document.getElementById('cloudStatus').addEventListener('click', showCloudStatusDetail);
        }

        // ==================== 雲端設定與操作 ====================

        function openCloudConfigModal() {
            const modal = document.getElementById('cloudConfigModal');
            const tokenInput = document.getElementById('githubToken');
            const gistIdInput = document.getElementById('gistId');
            
            // 載入已儲存的設定
            if (cloudSystem.token) {
                tokenInput.value = cloudSystem.token;
            }
            if (cloudSystem.gistId) {
                gistIdInput.value = cloudSystem.gistId;
            }
            
            modal.style.display = 'block';
        }

        function handleCloudConfig(e) {
            e.preventDefault();
            
            const token = document.getElementById('githubToken').value.trim();
            const gistId = document.getElementById('gistId').value.trim();
            
            if (!token || !gistId) {
                showToast('請填寫所有欄位');
                return;
            }
            
            cloudSystem.configure(token, gistId);
            document.getElementById('cloudConfigModal').style.display = 'none';
            updateCloudStatus();
            showToast('雲端設定已儲存');
            
            // 顯示雲端操作按鈕
            document.getElementById('cloudSyncBtn').classList.remove('hidden');
            document.getElementById('cloudDownloadBtn').classList.remove('hidden');
            document.getElementById('cloudSetupInfo').classList.add('hidden');
        }

        function updateCloudStatus() {
            const statusDiv = document.getElementById('cloudStatus');
            const syncBtn = document.getElementById('cloudSyncBtn');
            const downloadBtn = document.getElementById('cloudDownloadBtn');
            
            if (cloudSystem.isConfigured()) {
                statusDiv.innerHTML = `<i class="fas fa-cloud"></i> 雲端已連結`;
                statusDiv.classList.remove('bg-blue-700');
                statusDiv.classList.add('bg-green-600');
                syncBtn.classList.remove('hidden');
                downloadBtn.classList.remove('hidden');
                document.getElementById('cloudSetupInfo').classList.add('hidden');
            } else {
                statusDiv.innerHTML = `<i class="fas fa-cloud"></i> 雲端未設定`;
                statusDiv.classList.add('bg-blue-700');
                statusDiv.classList.remove('bg-green-600');
                syncBtn.classList.add('hidden');
                downloadBtn.classList.add('hidden');
                document.getElementById('cloudSetupInfo').classList.remove('hidden');
            }
        }

        function showCloudStatusDetail() {
            if (!cloudSystem.isConfigured()) {
                showToast('請先設定雲端');
                return;
            }
            
            let message = `Gist ID: ${cloudSystem.gistId}\n`;
            if (syncState.lastSyncTime) {
                message += `最後同步: ${syncState.lastSyncTime.toLocaleString()}\n`;
            } else {
                message += `尚未同步\n`;
            }
            alert(message);
        }

        async function manualBackup() {
            if (!cloudSystem.isConfigured()) {
                showToast('請先設定雲端');
                return;
            }
            
            if (appData.ledgers.length === 0) {
                showToast('沒有資料可備份');
                return;
            }
            
            if (syncState.isSyncing) {
                showToast('同步中，請稍候...');
                return;
            }
            
            syncState.isSyncing = true;
            const result = await cloudSystem.backup({
                ledgers: appData.ledgers,
                expenses: appData.expenses,
                lastModified: new Date().toISOString()
            });
            
            if (result.success) {
                syncState.lastSyncTime = new Date();
                showToast('備份成功！');
                updateSyncStatus();
            } else {
                showToast('備份失敗: ' + result.error);
            }
            
            syncState.isSyncing = false;
        }

        async function manualRestore() {
            if (!cloudSystem.isConfigured()) {
                showToast('請先設定雲端');
                return;
            }
            
            if (syncState.isSyncing) {
                showToast('同步中，請稍候...');
                return;
            }
            
            // 確認是否要覆蓋
            if (appData.ledgers.length > 0) {
                if (!confirm('目前已有資料，確定要從雲端還原嗎？')) {
                    return;
                }
            }
            
            syncState.isSyncing = true;
            const result = await cloudSystem.restore();
            
            if (result.success) {
                appData.ledgers = result.data.ledgers;
                appData.expenses = result.data.expenses;
                appData.currentLedgerId = result.data.ledgers.length > 0 ? result.data.ledgers[0].id : null;
                
                saveToLocalStorage();
                updateUI();
                syncState.lastSyncTime = new Date();
                showToast('還原成功！');
                updateSyncStatus();
            } else {
                showToast('還原失敗: ' + result.error);
            }
            
            syncState.isSyncing = false;
        }

        function updateSyncStatus() {
            const syncStatus = document.getElementById('syncStatus');
            
            if (!cloudSystem.isConfigured()) {
                syncStatus.classList.add('hidden');
                return;
            }
            
            if (syncState.lastSyncTime) {
                const timeStr = syncState.lastSyncTime.toLocaleTimeString();
                syncStatus.innerHTML = `<i class="fas fa-check"></i> ${timeStr}`;
                syncStatus.classList.remove('hidden');
                syncStatus.classList.add('bg-green-600', 'text-white');
            } else {
                syncStatus.classList.add('hidden');
            }
        }

        // ==================== 資料操作（手動） ====================

        // 匯出資料
        function exportData() {
            if (appData.ledgers.length === 0) {
                showToast('沒有資料可匯出');
                return;
            }
            
            const exportData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                data: {
                    ledgers: appData.ledgers,
                    expenses: appData.expenses
                }
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `travel-accounting-${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('資料已匯出');
        }

        // 匯入資料
        function importData(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const importData = JSON.parse(event.target.result);
                    
                    if (!importData.data || !importData.data.ledgers) {
                        showToast('檔案格式錯誤');
                        return;
                    }
                    
                    // 確認是否要覆蓋
                    if (appData.ledgers.length > 0) {
                        if (!confirm('目前已有資料，確定要覆蓋嗎？')) {
                            return;
                        }
                    }
                    
                    appData.ledgers = importData.data.ledgers;
                    appData.expenses = importData.data.expenses;
                    appData.currentLedgerId = importData.data.ledgers.length > 0 ? importData.data.ledgers[0].id : null;
                    
                    saveToLocalStorage();
                    updateUI();
                    showToast('資料已成功匯入');
                    
                } catch (error) {
                    console.error('匯入失敗:', error);
                    showToast('匯入失敗，檔案格式錯誤');
                }
            };
            reader.readAsText(file);
            
            // 清空 input，允許重複匯入同一個檔案
            e.target.value = '';
        }

        // ==================== 其他函數（與之前相同） ====================

        function handleLedgerSubmit(e) {
            e.preventDefault();
            
            try {
                const name = document.getElementById('ledgerName').value.trim();
                
                // 從標籤管理器抓取資料，不再使用 split(',')
                const categories = tempTags.categories;
                const locations = tempTags.locations;
                const members = tempTags.members;
                
                // 驗證名稱是否有填寫
                if (!name) {
                    showToast('請填寫帳冊名稱');
                    return;
                }

                // 驗證標籤是否至少各有一個
                if (categories.length === 0 || locations.length === 0 || members.length === 0) {
                    showToast('科目、地點與人員請至少各新增一項 (輸入後按 Enter)');
                    return;
                }
                
                const editId = document.getElementById('ledgerForm').getAttribute('data-edit-id');
                
                if (editId) {
                    const ledger = appData.ledgers.find(l => l.id === editId);
                    if (ledger) {
                        ledger.name = name;
                        // 直接存入陣列
                        ledger.categories = [...categories];
                        ledger.locations = [...locations];
                        ledger.members = [...members];
                    }
                    showToast('帳冊已更新');
                } else {
                    const newLedger = {
                        id: Date.now().toString(),
                        name,
                        categories: [...categories],
                        locations: [...locations],
                        members: [...members]
                    };
                    appData.ledgers.push(newLedger);
                    appData.currentLedgerId = newLedger.id;
                    showToast('帳冊已新增');
                }
                
                // 關閉 Modal 並存檔
                document.getElementById('ledgerModal').style.display = 'none';
                saveToLocalStorage();
                updateUI();
                
                // 重置標籤管理器
                tempTags = { categories: [], locations: [], members: [] };
                
            } catch (error) {
                console.error('儲存失敗:', error);
                showToast('儲存失敗，請檢查輸入');
            }
        }

        function handleExpenseSubmit(e) {
            e.preventDefault();
            
            if (!appData.currentLedgerId) {
                showToast('請先選擇一個帳冊');
                return;
            }
            
            const ledger = appData.ledgers.find(l => l.id === appData.currentLedgerId);
            const splitters = Array.from(document.querySelectorAll('.splitter-checkbox:checked')).map(cb => cb.value);
            
            if (splitters.length === 0) {
                showToast('請至少選擇一位分攤人員');
                return;
            }
            
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const averageAmount = (amount / splitters.length).toFixed(2);
            
            const expenseData = {
                id: currentEditingExpenseId || Date.now().toString(),
                ledgerId: appData.currentLedgerId,
                date: document.getElementById('expenseDate').value,
                time: document.getElementById('expenseTime').value,
                category: document.getElementById('expenseCategory').value,
                location: document.getElementById('expenseLocation').value,
                description: document.getElementById('expenseDescription').value.trim(),
                amount: amount,
                payer: document.getElementById('expensePayer').value,
                splitters: splitters,
                averageAmount: parseFloat(averageAmount),
                isSettled: document.getElementById('expenseSettled').checked,
                receipt: document.getElementById('receiptImagePreview').src || null
            };
            
            if (currentEditingExpenseId) {
                const index = appData.expenses.findIndex(e => e.id === currentEditingExpenseId);
                if (index !== -1) {
                    appData.expenses[index] = expenseData;
                    showToast('支出已更新');
                }
            } else {
                appData.expenses.push(expenseData);
                showToast('支出已新增');
            }
            
            saveToLocalStorage();
            updateExpenseList();
            document.getElementById('expenseModal').style.display = 'none';
        }

        function deleteExpense(id) {
            if (confirm('確定要刪除此支出嗎？')) {
                appData.expenses = appData.expenses.filter(e => e.id !== id);
                saveToLocalStorage();
                updateExpenseList();
                showToast('支出已刪除');
            }
        }

        function switchTab(tabName) {
            document.getElementById('expensesTab').classList.add('hidden');
            document.getElementById('queryTab').classList.add('hidden');
            document.getElementById('chartsTab').classList.add('hidden');
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('tab-active');
            });

            if (tabName === 'expenses') {
                document.getElementById('expensesTab').classList.remove('hidden');
                document.querySelector('[data-tab="expenses"]').classList.add('tab-active');
                updateExpenseList();
            } else if (tabName === 'query') {
                document.getElementById('queryTab').classList.remove('hidden');
                document.querySelector('[data-tab="query"]').classList.add('tab-active');
                updateQueryOptions();
            } else if (tabName === 'charts') {
                document.getElementById('chartsTab').classList.remove('hidden');
                document.querySelector('[data-tab="charts"]').classList.add('tab-active');
                updateCharts();
            }
        }

        function updateUI() {
            const ledgerSelect = document.getElementById('ledgerSelect');
            ledgerSelect.innerHTML = '<option value="">請選擇帳冊</option>' + 
                appData.ledgers.map(l => `<option value="${l.id}" ${appData.currentLedgerId === l.id ? 'selected' : ''}>${l.name}</option>`).join('');
            
            updateLedgerInfo();
            updateExpenseList();
            updateQueryOptions();
            updateSyncStatus();
        }

        function updateLedgerInfo() {
            const infoDiv = document.getElementById('ledgerInfo');
            
            if (!appData.currentLedgerId) {
                infoDiv.classList.add('hidden');
                return;
            }
            
            const ledger = appData.ledgers.find(l => l.id === appData.currentLedgerId);
            if (ledger) {
                document.getElementById('ledgerCategories').textContent = ledger.categories.join('、');
                document.getElementById('ledgerLocations').textContent = ledger.locations.join('、');
                document.getElementById('ledgerMembers').textContent = ledger.members.join('、');
                infoDiv.classList.remove('hidden');
            }
        }

        function openLedgerModal(ledgerId = null) {
            const modal = document.getElementById('ledgerModal');
            const title = document.getElementById('ledgerModalTitle');
            const form = document.getElementById('ledgerForm');
            
            form.reset();
            form.removeAttribute('data-edit-id');
            
           if (ledgerId) {
                const ledger = appData.ledgers.find(l => l.id === ledgerId);
                if (ledger) {
                    title.textContent = '編輯帳冊';
                    document.getElementById('ledgerName').value = ledger.name;
                    
                    // 將既有資料同步到標籤管理器
                    tempTags.categories = [...ledger.categories];
                    tempTags.locations = [...ledger.locations];
                    tempTags.members = [...ledger.members];
                    
                    form.setAttribute('data-edit-id', ledgerId);
                }
            } else {
                title.textContent = '新增帳冊';
                // 新增時清空標籤管理器
                tempTags = { categories: [], locations: [], members: [] };
            }

            // 觸發 UI 渲染，將資料轉化為可視化標籤
            renderTags('categories', 'categoryTagsContainer');
            renderTags('locations', 'locationTagsContainer');
            renderTags('members', 'memberTagsContainer');
            
            modal.style.display = 'block';
        }

        function editCurrentLedger() {
            if (!appData.currentLedgerId) {
                showToast('請先選擇一個帳冊');
                return;
            }
            openLedgerModal(appData.currentLedgerId);
        }

        function openExpenseModal(expenseId = null) {
            if (!appData.currentLedgerId) {
                showToast('請先選擇一個帳冊');
                return;
            }
            
            const modal = document.getElementById('expenseModal');
            const title = document.getElementById('expenseModalTitle');
            const form = document.getElementById('expenseForm');
            const ledger = appData.ledgers.find(l => l.id === appData.currentLedgerId);
            
            form.reset();
            currentEditingExpenseId = null;
            document.getElementById('receiptPreview').classList.add('hidden');
            
            const categorySelect = document.getElementById('expenseCategory');
            const locationSelect = document.getElementById('expenseLocation');
            const payerSelect = document.getElementById('expensePayer');
            const splittersContainer = document.getElementById('expenseSplitters');
            
            categorySelect.innerHTML = '<option value="">請選擇</option>' + 
                ledger.categories.map(c => `<option value="${c}">${c}</option>`).join('');
            
            locationSelect.innerHTML = '<option value="">請選擇</option>' + 
                ledger.locations.map(l => `<option value="${l}">${l}</option>`).join('');
            
            payerSelect.innerHTML = '<option value="">請選擇</option>' + 
                ledger.members.map(m => `<option value="${m}">${m}</option>`).join('');
            
            splittersContainer.innerHTML = ledger.members.map(m => `
                <label class="flex items-center space-x-2 p-1 hover:bg-gray-100 rounded">
                    <input type="checkbox" value="${m}" class="splitter-checkbox w-4 h-4">
                    <span>${m}</span>
                </label>
            `).join('');
            
            splittersContainer.addEventListener('change', updateAverageAmount);
            document.getElementById('expenseAmount').addEventListener('input', updateAverageAmount);
            
            if (expenseId) {
                const expense = appData.expenses.find(e => e.id === expenseId);
                if (expense) {
                    title.textContent = '編輯支出';
                    document.getElementById('expenseDate').value = expense.date;
                    document.getElementById('expenseTime').value = expense.time;
                    document.getElementById('expenseCategory').value = expense.category;
                    document.getElementById('expenseLocation').value = expense.location;
                    document.getElementById('expenseDescription').value = expense.description;
                    document.getElementById('expenseAmount').value = expense.amount;
                    document.getElementById('expensePayer').value = expense.payer;
                    document.getElementById('expenseSettled').checked = expense.isSettled;
                    
                    document.querySelectorAll('.splitter-checkbox').forEach(cb => {
                        cb.checked = expense.splitters.includes(cb.value);
                    });
                    
                    if (expense.receipt) {
                        document.getElementById('receiptImagePreview').src = expense.receipt;
                        document.getElementById('receiptPreview').classList.remove('hidden');
                    }
                    
                    currentEditingExpenseId = expenseId;
                    updateAverageAmount();
                }
            } else {
                title.textContent = '新增支出';
                const now = new Date();
                document.getElementById('expenseDate').value = now.toISOString().split('T')[0];
                document.getElementById('expenseTime').value = now.toTimeString().slice(0,5);
            }
            
            modal.style.display = 'block';
        }

        function updateAverageAmount() {
            const amount = parseFloat(document.getElementById('expenseAmount').value) || 0;
            const selectedSplitters = Array.from(document.querySelectorAll('.splitter-checkbox:checked')).map(cb => cb.value);
            const count = selectedSplitters.length;
            const average = count > 0 ? (amount / count).toFixed(2) : 0;
            document.getElementById('averageAmount').textContent = average;
        }

        function previewReceipt(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('receiptImagePreview').src = event.target.result;
                    document.getElementById('receiptPreview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function updateExpenseList() {
            const listContainer = document.getElementById('expenseList');
            
            if (!appData.currentLedgerId) {
                listContainer.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-info-circle text-2xl mb-2"></i>
                        <p>請先選擇或建立帳冊</p>
                    </div>
                `;
                return;
            }
            
            const ledgerExpenses = appData.expenses.filter(e => e.ledgerId === appData.currentLedgerId);
            
            if (ledgerExpenses.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-receipt text-2xl mb-2"></i>
                        <p>尚無支出記錄，請新增第一筆支出</p>
                    </div>
                `;
                return;
            }
            
            const sortedExpenses = [...ledgerExpenses].sort((a, b) => {
                const dateA = new Date(`${a.date} ${a.time}`);
                const dateB = new Date(`${b.date} ${b.time}`);
                return dateB - dateA;
            });
            
            listContainer.innerHTML = sortedExpenses.map(expense => {
                const receiptHtml = expense.receipt ? 
                    `<button class="view-receipt text-blue-600 hover:text-blue-800 text-sm" data-id="${expense.id}">
                        <i class="fas fa-image"></i> 查看收據
                    </button>` : '';
                
                return `
                    <div class="bg-white border border-gray-200 rounded-lg p-3 card-hover transition">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <div class="font-bold text-gray-800">${expense.category} - ${expense.description}</div>
                                <div class="text-sm text-gray-500">${expense.date} ${expense.time} @ ${expense.location}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-green-600 text-lg">${expense.amount.toFixed(2)}</div>
                                <div class="text-xs text-gray-500">${expense.isSettled ? '已結帳' : '未結帳'}</div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center text-sm text-gray-600 mb-2">
                            <span>支付：${expense.payer}</span>
                            <span>分攤：${expense.splitters.join('、')}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="text-xs text-gray-500">
                                平均分攤：${expense.averageAmount.toFixed(2)} / 人
                            </div>
                            <div class="flex space-x-2">
                                ${receiptHtml}
                                <button class="edit-expense text-blue-600 hover:text-blue-800 text-sm" data-id="${expense.id}">
                                    <i class="fas fa-edit"></i> 編輯
                                </button>
                                <button class="delete-expense text-red-600 hover:text-red-800 text-sm" data-id="${expense.id}">
                                    <i class="fas fa-trash"></i> 刪除
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.querySelectorAll('.edit-expense').forEach(btn => {
                btn.addEventListener('click', function() {
                    openExpenseModal(this.getAttribute('data-id'));
                });
            });
            
            document.querySelectorAll('.delete-expense').forEach(btn => {
                btn.addEventListener('click', function() {
                    deleteExpense(this.getAttribute('data-id'));
                });
            });
            
            document.querySelectorAll('.view-receipt').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    const expense = appData.expenses.find(e => e.id === id);
                    if (expense && expense.receipt) {
                        document.getElementById('receiptViewImage').src = expense.receipt;
                        document.getElementById('receiptViewModal').style.display = 'block';
                    }
                });
            });
        }

        function updateQueryOptions() {
            if (!appData.currentLedgerId) return;
            
            const ledgerExpenses = appData.expenses.filter(e => e.ledgerId === appData.currentLedgerId);
            
            const payerSelect = document.getElementById('queryPayer');
            const payers = [...new Set(ledgerExpenses.map(e => e.payer))];
            payerSelect.innerHTML = '<option value="">全部</option>' + 
                payers.map(p => `<option value="${p}">${p}</option>`).join('');
            
            const splitterSelect = document.getElementById('querySplitter');
            const allSplitters = new Set();
            ledgerExpenses.forEach(e => {
                e.splitters.forEach(s => allSplitters.add(s));
            });
            splitterSelect.innerHTML = '<option value="">全部</option>' + 
                Array.from(allSplitters).map(s => `<option value="${s}">${s}</option>`).join('');
        }

        function handleQuery() {
            if (!appData.currentLedgerId) {
                showToast('請先選擇一個帳冊');
                return;
            }
            
            const payer = document.getElementById('queryPayer').value;
            const splitter = document.getElementById('querySplitter').value;
            const settled = document.getElementById('querySettled').value;
            
            let filteredExpenses = appData.expenses.filter(e => e.ledgerId === appData.currentLedgerId);
            
            if (payer) {
                filteredExpenses = filteredExpenses.filter(e => e.payer === payer);
            }
            
            if (splitter) {
                filteredExpenses = filteredExpenses.filter(e => e.splitters.includes(splitter));
            }
            
            if (settled !== '') {
                const isSettled = settled === 'true';
                filteredExpenses = filteredExpenses.filter(e => e.isSettled === isSettled);
            }
            
            const totalAmount = filteredExpenses.reduce((sum, e) => sum + e.amount, 0);
            const totalCount = filteredExpenses.length;
            
            let splitterAmount = 0;
            let splitterDetails = [];
            
            if (splitter) {
                splitterDetails = filteredExpenses.map(e => {
                    return {
                        date: e.date,
                        description: e.description,
                        amount: e.amount,
                        average: e.averageAmount,
                        isSettled: e.isSettled
                    };
                });
                splitterAmount = splitterDetails.reduce((sum, d) => sum + d.average, 0);
            }
            
            document.getElementById('totalAmount').textContent = totalAmount.toFixed(2);
            document.getElementById('totalCount').textContent = totalCount;
            document.getElementById('splitterAmount').textContent = splitterAmount.toFixed(2);
            
            const detailsContainer = document.getElementById('splitterDetails');
            if (splitter && splitterDetails.length > 0) {
                detailsContainer.innerHTML = splitterDetails.map(d => `
                    <div class="flex justify-between text-sm py-1 border-b border-gray-200">
                        <span>${d.date} - ${d.description}</span>
                        <span class="${d.isSettled ? 'text-green-600' : 'text-red-600'}">
                            ${d.average.toFixed(2)} ${d.isSettled ? '✓' : '✗'}
                        </span>
                    </div>
                `).join('');
            } else {
                detailsContainer.innerHTML = '<div class="text-gray-500 text-sm">請選擇分攤人員查看詳細分攤明細</div>';
            }
            
            document.getElementById('queryResults').classList.remove('hidden');
        }

        function updateCharts() {
            if (!appData.currentLedgerId) {
                return;
            }
            
            const ledgerExpenses = appData.expenses.filter(e => e.ledgerId === appData.currentLedgerId);
            
            if (ledgerExpenses.length === 0) {
                return;
            }
            
            const payerData = {};
            ledgerExpenses.forEach(e => {
                payerData[e.payer] = (payerData[e.payer] || 0) + e.amount;
            });
            
            const splitterData = {};
            ledgerExpenses.forEach(e => {
                e.splitters.forEach(s => {
                    if (!splitterData[s]) {
                        splitterData[s] = { settled: 0, unsettled: 0 };
                    }
                    if (e.isSettled) {
                        splitterData[s].settled += e.averageAmount;
                    } else {
                        splitterData[s].unsettled += e.averageAmount;
                    }
                });
            });
            
            const payerCtx = document.getElementById('payerChart').getContext('2d');
            if (window.payerChartInstance) {
                window.payerChartInstance.destroy();
            }
            
            window.payerChartInstance = new Chart(payerCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(payerData),
                    datasets: [{
                        data: Object.values(payerData),
                        backgroundColor: [
                            '#3b82f6', '#10b981', '#f59e0b', '#ef4444', 
                            '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.parsed.toFixed(2)}`;
                                }
                            }
                        }
                    }
                }
            });
            
            const splitterCtx = document.getElementById('splitterChart').getContext('2d');
            if (window.splitterChartInstance) {
                window.splitterChartInstance.destroy();
            }
            
            const splitterLabels = Object.keys(splitterData);
            const settledData = splitterLabels.map(s => splitterData[s].settled);
            const unsettledData = splitterLabels.map(s => splitterData[s].unsettled);
            
            window.splitterChartInstance = new Chart(splitterCtx, {
                type: 'bar',
                data: {
                    labels: splitterLabels,
                    datasets: [
                        {
                            label: '已結帳',
                            data: settledData,
                            backgroundColor: '#10b981'
                        },
                        {
                            label: '未結帳',
                            data: unsettledData,
                            backgroundColor: '#ef4444'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function saveToLocalStorage() {
            localStorage.setItem('travelAccountingApp', JSON.stringify(appData));
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('travelAccountingApp');
            if (saved) {
                try {
                    appData = JSON.parse(saved);
                } catch (e) {
                    console.error('無法解析保存的數據', e);
                }
            }
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        function showSyncOverlay(show, message = '處理中...') {
            const overlay = document.getElementById('syncOverlay');
            if (show) {
                overlay.classList.remove('hidden');
                overlay.querySelector('div').innerHTML = `
                    <i class="fas fa-sync-alt fa-spin text-2xl text-blue-600 mb-2"></i>
                    <div class="font-bold">${message}</div>
                `;
            } else {
                overlay.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
